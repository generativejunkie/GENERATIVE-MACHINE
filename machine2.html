<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>SOUND MACHINE</title>
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body, a, button, label, input {
      cursor: none;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body, html { width: 100%; height: 100%; overflow: hidden; position: fixed; }
    #root { width: 100%; height: 100%; }
    .text-shadow { text-shadow: 0 0 5px rgba(255,255,255,0.5); }
    #custom-cursor {
      position: fixed;
      width: 24px;
      height: 24px;
      background-color: transparent;
      border: 1px solid #111827;
      border-radius: 50%;
      z-index: 9999;
      pointer-events: none;
      transform: translate(-50%, -50%);
      transition: transform 0.2s ease-out, background-color 0.2s ease-out, border-color 0.2s ease-out;
    }
    #custom-cursor.cursor-hover {
      background-color: #111827;
      border-color: transparent;
      transform: translate(-50%, -50%) scale(0.6);
    }
    @media (pointer: coarse) {
      #custom-cursor { display: none; }
      body, a, button, label, input { cursor: auto; }
    }
  </style>
</head>
<body>
  
  <div id="custom-cursor"></div>
  <div id="root"></div>

  <div class="fixed top-4 left-4 z-50">
      <a href="/" class="text-black text-lg hover:opacity-75 transition-opacity text-shadow">← Back</a>
  </div>
  <footer class="relative mt-12 mb-4 text-center md:fixed md:bottom-4 md:left-0 md:right-0 md:mt-0 md:mb-0">
    <p class="text-black text-shadow" style="font-size: 10px; font-family: Verdana, sans-serif;">©︎2025</p>
  </footer>
  
  <script>
    let audioContext, analyser, source, buffer;
    let startTime = 0, pauseTime = 0;
    let isPlaying = false;
    let fileName = '', artist = 'Unknown Artist', duration = 0, currentTime = 0;
    let frequencyData = { low: 0, mid: 0, high: 0 };
    let settingsOpen = false;
    let pillCount = 1, pillSize = 0.7, spreadWidth = 0;
    let rotationSpeed = 1, scaleIntensity = 1;
    let wireframeMode = false, blockMode = false;
    let scene, camera, renderer, pillGroups = [];
    let canvas;

    function init() {
      const root = document.getElementById('root');
      canvas = document.createElement('canvas');
      canvas.className = 'absolute inset-0';
      root.appendChild(canvas);
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0xcccccc);
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100);
      camera.position.set(0, 0, 5);
      camera.lookAt(0, 0, 0);
      renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
      scene.add(ambientLight);
      const mainLight = new THREE.DirectionalLight(0xffffff, 1);
      mainLight.position.set(5, 5, 5);
      scene.add(mainLight);
      createPills();
      createUI();
      window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
      animate();

      const cursor = document.getElementById('custom-cursor');
      const interactiveElements = document.querySelectorAll('a, button, label, input[type="range"]');
      window.addEventListener('mousemove', (e) => {
        cursor.style.left = `${e.clientX}px`;
        cursor.style.top = `${e.clientY}px`;
      });
      interactiveElements.forEach(el => {
        el.addEventListener('mouseover', () => { cursor.classList.add('cursor-hover'); });
        el.addEventListener('mouseout', () => { cursor.classList.remove('cursor-hover'); });
      });
    }

    function createPill() {
      const pillGroup = new THREE.Group();
      const whiteMat = new THREE.MeshStandardMaterial({ color: 0xffffff, metalness: 0.3, roughness: 0.4, emissive: 0x111111, wireframe: wireframeMode });
      const blackMat = new THREE.MeshStandardMaterial({ color: 0x000000, metalness: 0.3, roughness: 0.4, emissive: 0x000000, wireframe: wireframeMode });
      if (blockMode) {
        const topBox = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.8, 0.8), whiteMat);
        topBox.position.y = 0.5;
        pillGroup.add(topBox);
        const bottomBox = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.8, 0.8), blackMat);
        bottomBox.position.y = -0.5;
        pillGroup.add(bottomBox);
      } else {
        const topCyl = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 1, 32), whiteMat);
        topCyl.position.y = 0.5;
        pillGroup.add(topCyl);
        const bottomCyl = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 1, 32), blackMat);
        bottomCyl.position.y = -0.5;
        pillGroup.add(bottomCyl);
        const topSphere = new THREE.Mesh(new THREE.SphereGeometry(0.5, 32, 32, 0, Math.PI * 2, 0, Math.PI / 2), whiteMat);
        topSphere.position.y = 1;
        pillGroup.add(topSphere);
        const bottomSphere = new THREE.Mesh(new THREE.SphereGeometry(0.5, 32, 32, 0, Math.PI * 2, 0, Math.PI / 2), blackMat);
        bottomSphere.position.y = -1;
        bottomSphere.rotation.x = Math.PI;
        pillGroup.add(bottomSphere);
      }
      return pillGroup;
    }
    
    function createPills() {
      pillGroups.forEach(pill => { scene.remove(pill); pill.children.forEach(child => { if (child.geometry) child.geometry.dispose(); if (child.material) child.material.dispose(); }); });
      pillGroups = [];
      for (let i = 0; i < pillCount; i++) {
        const pill = createPill();
        if (pillCount === 1) { pill.position.set(0, 0, 0); } else { const angle = (i / pillCount) * Math.PI * 2; pill.position.set( Math.cos(angle) * spreadWidth, 0, Math.sin(angle) * spreadWidth ); }
        scene.add(pill);
        pillGroups.push(pill);
      }
    }
    
    function animate() {
      requestAnimationFrame(animate);
      let low = 0, mid = 0, high = 0;
      if (analyser && isPlaying) {
        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(dataArray);
        const bufferLength = dataArray.length;
        const lowEnd = Math.floor(bufferLength * 0.1);
        const midEnd = Math.floor(bufferLength * 0.5);
        for (let i = 0; i < lowEnd; i++) low += dataArray[i];
        for (let i = lowEnd; i < midEnd; i++) mid += dataArray[i];
        for (let i = midEnd; i < bufferLength; i++) high += dataArray[i];
        low = isNaN(low / lowEnd) ? 0 : (low / lowEnd) / 255;
        mid = isNaN(mid / (midEnd - lowEnd)) ? 0 : (mid / (midEnd - lowEnd)) / 255;
        high = isNaN(high / (bufferLength - midEnd)) ? 0 : (high / (bufferLength - midEnd)) / 255;
        frequencyData = { low, mid, high };
        if (audioContext && source) {
          const elapsed = audioContext.currentTime - startTime;
          currentTime = Math.min(elapsed, duration);
          updateTimeDisplay();
        }
      }
      pillGroups.forEach((pillGroup, index) => {
        const audioReaction = (low + mid + high) / 3;
        const targetScale = pillSize + audioReaction * 1.0 * scaleIntensity;
        pillGroup.scale.set(targetScale, targetScale, targetScale);
        const speed = rotationSpeed;
        pillGroup.rotation.x += (0.005 + mid * 0.02) * speed;
        pillGroup.rotation.y += (0.003 + low * 0.01) * speed;
        pillGroup.rotation.z += (0.002 + high * 0.015) * speed;
        if (pillCount > 1) {
          const angle = (index / pillCount) * Math.PI * 2;
          pillGroup.position.x = Math.cos(angle) * spreadWidth;
          pillGroup.position.z = Math.sin(angle) * spreadWidth;
        }
        const emissive = audioReaction * 0.5;
        pillGroup.children.forEach((child, idx) => {
          if (child.material) {
            const isWhitePart = idx === 0 || idx === 2;
            const colorValue = isWhitePart ? 1 - emissive * 0.3 : emissive * 0.3;
            const emissiveValue = isWhitePart ? emissive * 0.5 : emissive * 0.2;
            child.material.color.setRGB(colorValue, colorValue, colorValue);
            child.material.emissive.setRGB(emissiveValue, emissiveValue, emissiveValue);
          }
        });
      });
      renderer.render(scene, camera);
    }
    
    async function handleFileChange(e) {
      const file = e.target.files[0];
      if (!file) return;
      if (source) { try { source.stop(); source.disconnect(); } catch (e) {} source = null; }
      isPlaying = false; pauseTime = 0; currentTime = 0;
      fileName = file.name;
      const nameParts = file.name.replace(/\.[^/.]+$/, '').split('-');
      artist = nameParts.length > 1 ? nameParts[0].trim() : 'Unknown Artist';
      updateUI();
      try {
        if (!audioContext) { audioContext = new (window.AudioContext || window.webkitAudioContext)(); }
        if (audioContext.state !== 'running') { await audioContext.resume(); }
        const arrayBuffer = await file.arrayBuffer();
        try {
          buffer = await audioContext.decodeAudioData(arrayBuffer);
          duration = buffer.duration;
        } catch (decodeError) { alert('このファイル形式は再生できません。MP3またはWAVファイルを選択してください。'); return; }
        if (!analyser) {
          analyser = audioContext.createAnalyser();
          analyser.fftSize = 1024;
          analyser.smoothingTimeConstant = 0.8;
          analyser.connect(audioContext.destination);
        }
        updateUI();
      } catch (error) { alert('エラー: ' + error.message); }
    }
    
    async function togglePlay() {
      if (!audioContext || !buffer || !analyser) { alert('ファイルを選択してください'); return; }
      if (isPlaying) {
        if (source) { try { source.stop(); } catch (e) {} }
        pauseTime = audioContext.currentTime - startTime;
        isPlaying = false;
        updateUI();
        return;
      }
      try {
        if (audioContext.state !== 'running') { await audioContext.resume(); }
        source = audioContext.createBufferSource();
        source.buffer = buffer;
        source.connect(analyser);
        const offset = pauseTime || 0;
        startTime = audioContext.currentTime - offset;
        source.start(0, offset);
        source.onended = () => { isPlaying = false; pauseTime = 0; currentTime = 0; updateUI(); };
        isPlaying = true;
        updateUI();
      } catch (error) { alert('再生エラー: ' + error.message); }
    }
    
    function createUI() {
      const root = document.getElementById('root');
      const settingsBtn = document.createElement('button');
      settingsBtn.className = 'absolute top-4 right-4 w-10 h-10 rounded-full bg-black/60 hover:bg-black/70 transition-colors flex items-center justify-center border border-white/20 z-50';
      settingsBtn.innerHTML = '<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>';
      settingsBtn.onclick = () => { settingsOpen = !settingsOpen; updateUI(); };
      root.appendChild(settingsBtn);
      const settingsPanel = document.createElement('div');
      settingsPanel.id = 'settings-panel';
      settingsPanel.className = 'absolute top-16 right-4 w-64 backdrop-blur-xl bg-black/70 rounded-xl p-4 border border-white/20 text-xs z-40';
      settingsPanel.style.display = 'none';
      settingsPanel.innerHTML = `
        <h3 class="text-white text-sm font-light mb-3">Settings</h3>
        <div class="mb-3"><label class="text-white/70 text-xs mb-1 block">Capsules: <span id="pill-count-val">1</span></label><input type="range" id="pill-count" min="1" max="12" value="1" class="w-full"></div>
        <div class="mb-3"><label class="text-white/70 text-xs mb-1 block">Capsule Size: <span id="pill-size-val">0.7</span></label><input type="range" id="pill-size" min="0.3" max="1.5" step="0.1" value="0.7" class="w-full"></div>
        <div class="mb-3"><label class="text-white/70 text-xs mb-1 block">Spread: <span id="spread-val">0.0</span></label><input type="range" id="spread" min="0" max="5" step="0.1" value="0" class="w-full"></div>
        <div class="mb-3"><label class="text-white/70 text-xs mb-1 block">Rotation Speed: <span id="rotation-val">1.0</span>x</label><input type="range" id="rotation" min="0" max="3" step="0.1" value="1" class="w-full"></div>
        <div class="mb-3"><label class="text-white/70 text-xs mb-1 block">Scale: <span id="scale-val">1.0</span>x</label><input type="range" id="scale" min="0" max="3" step="0.1" value="1" class="w-full"></div>
        <div class="mb-3"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="wireframe" class="w-3 h-3"><span class="text-white/70 text-xs">Wireframe Mode</span></label></div>
        <div class="mb-3"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="block-mode" class="w-3 h-3"><span class="text-white/70 text-xs">Block Mode</span></label></div>
        <button id="reset-btn" class="w-full py-1.5 px-3 bg-white/10 hover:bg-white/20 rounded text-white text-xs transition-colors">Reset to Default</button>
      `;
      root.appendChild(settingsPanel);
      document.getElementById('pill-count').oninput = (e) => { pillCount = parseInt(e.target.value); document.getElementById('pill-count-val').textContent = pillCount; createPills(); };
      document.getElementById('pill-size').oninput = (e) => { pillSize = parseFloat(e.target.value); document.getElementById('pill-size-val').textContent = pillSize.toFixed(1); };
      document.getElementById('spread').oninput = (e) => { spreadWidth = parseFloat(e.target.value); document.getElementById('spread-val').textContent = spreadWidth.toFixed(1); createPills(); };
      document.getElementById('rotation').oninput = (e) => { rotationSpeed = parseFloat(e.target.value); document.getElementById('rotation-val').textContent = rotationSpeed.toFixed(1); };
      document.getElementById('scale').oninput = (e) => { scaleIntensity = parseFloat(e.target.value); document.getElementById('scale-val').textContent = scaleIntensity.toFixed(1); };
      document.getElementById('wireframe').onchange = (e) => { wireframeMode = e.target.checked; createPills(); };
      document.getElementById('block-mode').onchange = (e) => { blockMode = e.target.checked; createPills(); };
      document.getElementById('reset-btn').onclick = () => {
        pillCount = 1; pillSize = 0.7; spreadWidth = 0; rotationSpeed = 1; scaleIntensity = 1; wireframeMode = false; blockMode = false;
        ['pill-count','pill-size','spread','rotation','scale'].forEach(id => document.getElementById(id).value = {'pill-count':1,'pill-size':0.7,'spread':0,'rotation':1,'scale':1}[id]);
        ['wireframe','block-mode'].forEach(id => document.getElementById(id).checked = false);
        ['pill-count-val','pill-size-val','spread-val','rotation-val','scale-val'].forEach(id => document.getElementById(id).textContent = {'pill-count-val':'1','pill-size-val':'0.7','spread-val':'0.0','rotation-val':'1.0','scale-val':'1.0'}[id]);
        createPills();
      };
      const dropZone = document.createElement('div');
      dropZone.id = 'drop-zone';
      dropZone.className = 'absolute inset-0 flex items-center justify-center z-10';
      dropZone.innerHTML = `
        <label class="cursor-pointer">
          <input type="file" id="file-input" accept="audio/mpeg,audio/mp3,audio/wav,audio/aac,audio/*" class="hidden">
          <div class="text-gray-800 text-center px-8 py-12 rounded-lg transition-colors backdrop-blur-md bg-white/30">
            <svg class="w-16 h-16 mx-auto mb-4 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/></svg>
            <p class="text-lg font-light mb-2">Drop audio file here</p>
            <p class="text-sm text-gray-600">or click to browse</p>
          </div>
        </label>
      `;
      root.appendChild(dropZone);
      document.getElementById('file-input').onchange = handleFileChange;
      const controlPanel = document.createElement('div');
      controlPanel.id = 'control-panel';
      controlPanel.className = 'absolute bottom-12 left-0 right-0 p-3 z-20';
      controlPanel.style.display = 'none';
      controlPanel.innerHTML = `
        <div class="max-w-4xl mx-auto backdrop-blur-xl bg-black/60 rounded-xl p-3 border border-white/20">
          <div class="mb-2"><div class="text-white text-sm font-light truncate mb-0.5" id="file-name"></div><div class="text-white/50 text-xs font-light" id="artist-name"></div></div>
          <div class="flex items-center gap-4">
            <div class="flex-1 flex items-center gap-3"><span class="text-white/70 text-xs font-mono w-10 text-right" id="current-time">0:00</span><div class="flex-1 h-1.5 bg-white/20 rounded-full cursor-pointer relative group" id="seek-bar"><div id="progress-bar" class="h-full bg-white rounded-full transition-all duration-100" style="width: 0%"></div></div><span class="text-white/70 text-xs font-mono w-10" id="duration-time">0:00</span></div>
            <div class="flex items-end gap-1 h-12" id="freq-bars"></div>
            <div class="flex items-center gap-2">
              <button id="play-btn" class="w-10 h-10 rounded-full bg-white/20 hover:bg-white/30 transition-colors flex items-center justify-center border border-white/30"><svg class="w-5 h-5 text-white ml-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
              <label class="cursor-pointer"><input type="file" id="file-input-2" accept="audio/mpeg,audio/mp3,audio/wav,audio/aac,audio/*" class="hidden"><div class="w-8 h-8 rounded-full bg-white/20 hover:bg-white/30 transition-colors flex items-center justify-center border border-white/30"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/></svg></div></label>
            </div>
          </div>
        </div>
      `;
      root.appendChild(controlPanel);
      document.getElementById('file-input-2').onchange = handleFileChange;
      document.getElementById('play-btn').onclick = togglePlay;
      const freqBars = document.getElementById('freq-bars');
      ['low', 'mid', 'high'].forEach(freq => {
        const col = document.createElement('div');
        col.className = 'flex flex-col items-center gap-1';
        let bars = '<div class="flex flex-col-reverse gap-0.5 h-12">';
        for (let i = 0; i < 10; i++) {
          bars += `<div class="freq-bar freq-${freq} w-3 h-0.5 rounded-sm transition-all duration-75 bg-[#1a1a1a]" data-index="${i}"></div>`;
        }
        bars += `</div><span class="text-white/60 text-[9px] uppercase tracking-wider font-mono">${freq[0].toUpperCase()}</span>`;
        col.innerHTML = bars;
        freqBars.appendChild(col);
      });
    }
    function updateUI() {
      const dropZone = document.getElementById('drop-zone');
      const controlPanel = document.getElementById('control-panel');
      const settingsPanel = document.getElementById('settings-panel');
      if (fileName) {
        dropZone.style.display = 'none';
        controlPanel.style.display = 'block';
        document.getElementById('file-name').textContent = fileName.replace(/\.[^/.]+$/, '');
        document.getElementById('artist-name').textContent = artist;
      }
      settingsPanel.style.display = settingsOpen ? 'block' : 'none';
      const playBtn = document.getElementById('play-btn');
      if (playBtn) {
        playBtn.innerHTML = isPlaying 
          ? '<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/></svg>'
          : '<svg class="w-5 h-5 text-white ml-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
      }
    }
    function updateTimeDisplay() {
      if(document.getElementById('current-time')) {
        document.getElementById('current-time').textContent = formatTime(currentTime);
        document.getElementById('duration-time').textContent = formatTime(duration);
        document.getElementById('progress-bar').style.width = `${(currentTime / duration) * 100}%`;
      }
      ['low', 'mid', 'high'].forEach(freq => {
        const bars = document.querySelectorAll(`.freq-${freq}`);
        bars.forEach((bar, i) => {
          const threshold = i / 10;
          const isActive = frequencyData[freq] >= threshold;
          let color = '#00ff00';
          if (i >= 8) color = '#ff0000'; else if (i >= 6) color = '#ffaa00'; else if (i >= 4) color = '#ffff00';
          bar.style.backgroundColor = isActive ? color : '#1a1a1a';
          bar.style.boxShadow = isActive ? `0 0 4px ${color}` : 'none';
        });
      });
    }
    function formatTime(sec) {
      if (isNaN(sec)) return '0:00';
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return `${m}:${s.toString().padStart(2, '0')}`;
    }

    init();
  </script>
</body>
</html>